(function() {
  var $fs, $path, Flasset, SourceCollector, async, exec,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  $fs = require('fs-extra');

  $path = require('path');

  async = require('async');

  exec = require('done-exec');

  SourceCollector = require('./flutils').SourceCollector;

  Flasset = (function() {
    function Flasset(build) {
      this.createAsset = __bind(this.createAsset, this);
      this.addAssetDirectory = __bind(this.addAssetDirectory, this);
      this.collector = new SourceCollector(build);
      this.build = build;
      this.assets = [];
    }

    Flasset.prototype.embed = function(extname, file, className) {
      switch (extname.toLowerCase()) {
        case '.jpg':
        case '.jpeg':
        case '.gif':
        case '.png':
        case '.svg':
        case '.mp3':
        case '.swf':
          return "[Embed(source='" + file + "')] public static const " + className + " : Class;";
        default:
          return "[Embed(source='" + file + "', mimeType='application/octet-stream')] public static const " + className + " : Class;";
      }
    };

    Flasset.prototype.addAssetDirectory = function(assetClassPath, directory) {
      return this.assets.push({
        assetClassPath: assetClassPath,
        directory: directory
      });
    };

    Flasset.prototype.createAsset = function(output, complete) {
      var cacheDirectory, classNameReg, embed, task;
      cacheDirectory = $path.normalize('.assets_cache');
      classNameReg = /^[A-Za-z][A-Za-z0-9_]+/;
      embed = this.embed;
      this.collector.addSourceDirectory($path.join(cacheDirectory, 'src'));
      if ($fs.existsSync(cacheDirectory)) {
        $fs.removeSync(cacheDirectory);
      }
      task = function(obj, next) {
        var assetClassPath, className, directory, namespace, paths, sourceDirectory;
        assetClassPath = obj['assetClassPath'];
        directory = obj['directory'];
        paths = assetClassPath.split('.');
        className = paths.pop();
        namespace = paths.join('.');
        paths.unshift(cacheDirectory, 'src');
        sourceDirectory = paths.join('/');
        return $fs.mkdirs(sourceDirectory, function(err) {
          if (err != null) {
            next(err);
            return;
          }
          return $fs.copy(directory, sourceDirectory, function(err) {
            var embeds, extname, file, fileClassName, files, source, stat, _i, _len;
            if (err != null) {
              next(err);
              return;
            }
            files = $fs.readdirSync(sourceDirectory);
            embeds = [];
            for (_i = 0, _len = files.length; _i < _len; _i++) {
              file = files[_i];
              stat = $fs.statSync($path.join(sourceDirectory, file));
              extname = $path.extname(file);
              fileClassName = file.replace(extname, '');
              if (stat.isFile() && classNameReg.test(fileClassName)) {
                embeds.push(embed(extname, file, fileClassName));
              }
            }
            source = "package " + namespace + " {\npublic class " + className + " {\n" + (embeds.join('\n')) + "\n}\n}";
            return $fs.writeFile($path.join(sourceDirectory, "" + className + ".as"), source, {
              encoding: 'utf8'
            }, function(err) {
              if (err != null) {
                next(err);
                return;
              }
              return next();
            });
          });
        });
      };
      return async.eachSeries(this.assets, task, (function(_this) {
        return function(err) {
          var bin;
          if (err != null) {
            complete(err);
            return;
          }
          bin = 'compc';
          return _this.build.getSDKVersion(function(version) {
            var args, directory, library, _i, _j, _k, _len, _len1, _len2, _ref, _ref1, _ref2;
            if (process.platform.indexOf('win') === 0) {
              if (version > '4.6.0') {
                bin = 'compc.bat';
              } else {
                bin = 'compc.exe';
              }
            }
            args = [];
            args.push(_this.build.wrap(_this.build.getEnv('FLEX_HOME') + '/bin/' + bin));
            _ref = _this.collector.getLibraries();
            for (_i = 0, _len = _ref.length; _i < _len; _i++) {
              library = _ref[_i];
              args.push('-library-path ' + _this.build.wrap(library));
            }
            _ref1 = _this.collector.getExternalLibraries();
            for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
              library = _ref1[_j];
              args.push('-external-library-path ' + _this.build.wrap(library));
            }
            _ref2 = _this.collector.getSourceDirectories();
            for (_k = 0, _len2 = _ref2.length; _k < _len2; _k++) {
              directory = _ref2[_k];
              args.push('-source-path ' + _this.build.wrap(directory));
              args.push('-include-sources ' + _this.build.wrap(directory));
            }
            args.push('-output ' + _this.build.wrap(_this.build.resolvePath(output)));
            return exec(args.join(' ')).run(function() {
              if ($fs.existsSync(cacheDirectory)) {
                $fs.removeSync(cacheDirectory);
              }
              console.log(cacheDirectory);
              return complete();
            });
          });
        };
      })(this));
    };

    return Flasset;

  })();

  module.exports = Flasset;

}).call(this);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImZsYXNzZXQuY29mZmVlIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQUEsTUFBQSxpREFBQTtJQUFBLGtGQUFBOztBQUFBLEVBQUEsR0FBQSxHQUFNLE9BQUEsQ0FBUSxVQUFSLENBQU4sQ0FBQTs7QUFBQSxFQUNBLEtBQUEsR0FBUSxPQUFBLENBQVEsTUFBUixDQURSLENBQUE7O0FBQUEsRUFFQSxLQUFBLEdBQVEsT0FBQSxDQUFRLE9BQVIsQ0FGUixDQUFBOztBQUFBLEVBR0EsSUFBQSxHQUFPLE9BQUEsQ0FBUSxXQUFSLENBSFAsQ0FBQTs7QUFBQSxFQUlDLGtCQUFtQixPQUFBLENBQVEsV0FBUixFQUFuQixlQUpELENBQUE7O0FBQUEsRUFPTTtBQUNRLElBQUEsaUJBQUMsS0FBRCxHQUFBO0FBQ1osdURBQUEsQ0FBQTtBQUFBLG1FQUFBLENBQUE7QUFBQSxNQUFBLElBQUMsQ0FBQSxTQUFELEdBQWlCLElBQUEsZUFBQSxDQUFnQixLQUFoQixDQUFqQixDQUFBO0FBQUEsTUFDQSxJQUFDLENBQUEsS0FBRCxHQUFTLEtBRFQsQ0FBQTtBQUFBLE1BRUEsSUFBQyxDQUFBLE1BQUQsR0FBVSxFQUZWLENBRFk7SUFBQSxDQUFiOztBQUFBLHNCQUtBLEtBQUEsR0FBTyxTQUFDLE9BQUQsRUFBVSxJQUFWLEVBQWdCLFNBQWhCLEdBQUE7QUFDTixjQUFPLE9BQU8sQ0FBQyxXQUFSLENBQUEsQ0FBUDtBQUFBLGFBQ00sTUFETjtBQUFBLGFBQ2MsT0FEZDtBQUFBLGFBQ3VCLE1BRHZCO0FBQUEsYUFDK0IsTUFEL0I7QUFBQSxhQUN1QyxNQUR2QztBQUFBLGFBQytDLE1BRC9DO0FBQUEsYUFDdUQsTUFEdkQ7aUJBQ29FLGlCQUFBLEdBQWdCLElBQWhCLEdBQXNCLDBCQUF0QixHQUErQyxTQUEvQyxHQUEwRCxZQUQ5SDtBQUFBO2lCQUVPLGlCQUFBLEdBQWdCLElBQWhCLEdBQXNCLCtEQUF0QixHQUFvRixTQUFwRixHQUErRixZQUZ0RztBQUFBLE9BRE07SUFBQSxDQUxQLENBQUE7O0FBQUEsc0JBYUEsaUJBQUEsR0FBbUIsU0FBQyxjQUFELEVBQWlCLFNBQWpCLEdBQUE7YUFDbEIsSUFBQyxDQUFBLE1BQU0sQ0FBQyxJQUFSLENBQ0M7QUFBQSxRQUFBLGNBQUEsRUFBZ0IsY0FBaEI7QUFBQSxRQUNBLFNBQUEsRUFBVyxTQURYO09BREQsRUFEa0I7SUFBQSxDQWJuQixDQUFBOztBQUFBLHNCQXVCQSxXQUFBLEdBQWEsU0FBQyxNQUFELEVBQVMsUUFBVCxHQUFBO0FBQ1osVUFBQSx5Q0FBQTtBQUFBLE1BQUEsY0FBQSxHQUFpQixLQUFLLENBQUMsU0FBTixDQUFnQixlQUFoQixDQUFqQixDQUFBO0FBQUEsTUFDQSxZQUFBLEdBQWUsd0JBRGYsQ0FBQTtBQUFBLE1BRUEsS0FBQSxHQUFRLElBQUMsQ0FBQSxLQUZULENBQUE7QUFBQSxNQUlBLElBQUMsQ0FBQSxTQUFTLENBQUMsa0JBQVgsQ0FBOEIsS0FBSyxDQUFDLElBQU4sQ0FBVyxjQUFYLEVBQTJCLEtBQTNCLENBQTlCLENBSkEsQ0FBQTtBQU9BLE1BQUEsSUFBa0MsR0FBRyxDQUFDLFVBQUosQ0FBZSxjQUFmLENBQWxDO0FBQUEsUUFBQSxHQUFHLENBQUMsVUFBSixDQUFlLGNBQWYsQ0FBQSxDQUFBO09BUEE7QUFBQSxNQVNBLElBQUEsR0FBTyxTQUFDLEdBQUQsRUFBTSxJQUFOLEdBQUE7QUFDTixZQUFBLHVFQUFBO0FBQUEsUUFBQSxjQUFBLEdBQWlCLEdBQUksQ0FBQSxnQkFBQSxDQUFyQixDQUFBO0FBQUEsUUFDQSxTQUFBLEdBQVksR0FBSSxDQUFBLFdBQUEsQ0FEaEIsQ0FBQTtBQUFBLFFBR0EsS0FBQSxHQUFRLGNBQWMsQ0FBQyxLQUFmLENBQXFCLEdBQXJCLENBSFIsQ0FBQTtBQUFBLFFBSUEsU0FBQSxHQUFZLEtBQUssQ0FBQyxHQUFOLENBQUEsQ0FKWixDQUFBO0FBQUEsUUFLQSxTQUFBLEdBQVksS0FBSyxDQUFDLElBQU4sQ0FBVyxHQUFYLENBTFosQ0FBQTtBQUFBLFFBTUEsS0FBSyxDQUFDLE9BQU4sQ0FBYyxjQUFkLEVBQThCLEtBQTlCLENBTkEsQ0FBQTtBQUFBLFFBUUEsZUFBQSxHQUFrQixLQUFLLENBQUMsSUFBTixDQUFXLEdBQVgsQ0FSbEIsQ0FBQTtlQWFBLEdBQUcsQ0FBQyxNQUFKLENBQVcsZUFBWCxFQUE0QixTQUFDLEdBQUQsR0FBQTtBQUMzQixVQUFBLElBQUcsV0FBSDtBQUNDLFlBQUEsSUFBQSxDQUFLLEdBQUwsQ0FBQSxDQUFBO0FBQ0Esa0JBQUEsQ0FGRDtXQUFBO2lCQU9BLEdBQUcsQ0FBQyxJQUFKLENBQVMsU0FBVCxFQUFvQixlQUFwQixFQUFxQyxTQUFDLEdBQUQsR0FBQTtBQUNwQyxnQkFBQSxtRUFBQTtBQUFBLFlBQUEsSUFBRyxXQUFIO0FBQ0MsY0FBQSxJQUFBLENBQUssR0FBTCxDQUFBLENBQUE7QUFDQSxvQkFBQSxDQUZEO2FBQUE7QUFBQSxZQU9BLEtBQUEsR0FBUSxHQUFHLENBQUMsV0FBSixDQUFnQixlQUFoQixDQVBSLENBQUE7QUFBQSxZQVFBLE1BQUEsR0FBUyxFQVJULENBQUE7QUFVQSxpQkFBQSw0Q0FBQTsrQkFBQTtBQUNDLGNBQUEsSUFBQSxHQUFPLEdBQUcsQ0FBQyxRQUFKLENBQWEsS0FBSyxDQUFDLElBQU4sQ0FBVyxlQUFYLEVBQTRCLElBQTVCLENBQWIsQ0FBUCxDQUFBO0FBQUEsY0FDQSxPQUFBLEdBQVUsS0FBSyxDQUFDLE9BQU4sQ0FBYyxJQUFkLENBRFYsQ0FBQTtBQUFBLGNBRUEsYUFBQSxHQUFnQixJQUFJLENBQUMsT0FBTCxDQUFhLE9BQWIsRUFBc0IsRUFBdEIsQ0FGaEIsQ0FBQTtBQUlBLGNBQUEsSUFBRyxJQUFJLENBQUMsTUFBTCxDQUFBLENBQUEsSUFBa0IsWUFBWSxDQUFDLElBQWIsQ0FBa0IsYUFBbEIsQ0FBckI7QUFDQyxnQkFBQSxNQUFNLENBQUMsSUFBUCxDQUFZLEtBQUEsQ0FBTSxPQUFOLEVBQWUsSUFBZixFQUFxQixhQUFyQixDQUFaLENBQUEsQ0FERDtlQUxEO0FBQUEsYUFWQTtBQUFBLFlBbUJBLE1BQUEsR0FBWSxVQUFBLEdBQ1QsU0FEUyxHQUNFLG1CQURGLEdBRVgsU0FGVyxHQUVBLE1BRkEsR0FFSSxDQUFBLE1BQU0sQ0FBQyxJQUFQLENBQVksSUFBWixDQUFBLENBRkosR0FHWixRQXRCQSxDQUFBO21CQThCQSxHQUFHLENBQUMsU0FBSixDQUFjLEtBQUssQ0FBQyxJQUFOLENBQVcsZUFBWCxFQUE0QixFQUFBLEdBQUUsU0FBRixHQUFhLEtBQXpDLENBQWQsRUFBOEQsTUFBOUQsRUFBc0U7QUFBQSxjQUFDLFFBQUEsRUFBUyxNQUFWO2FBQXRFLEVBQXlGLFNBQUMsR0FBRCxHQUFBO0FBQ3hGLGNBQUEsSUFBRyxXQUFIO0FBQ0MsZ0JBQUEsSUFBQSxDQUFLLEdBQUwsQ0FBQSxDQUFBO0FBQ0Esc0JBQUEsQ0FGRDtlQUFBO3FCQUlBLElBQUEsQ0FBQSxFQUx3RjtZQUFBLENBQXpGLEVBL0JvQztVQUFBLENBQXJDLEVBUjJCO1FBQUEsQ0FBNUIsRUFkTTtNQUFBLENBVFAsQ0FBQTthQXdFQSxLQUFLLENBQUMsVUFBTixDQUFpQixJQUFDLENBQUEsTUFBbEIsRUFBMEIsSUFBMUIsRUFBZ0MsQ0FBQSxTQUFBLEtBQUEsR0FBQTtlQUFBLFNBQUMsR0FBRCxHQUFBO0FBQy9CLGNBQUEsR0FBQTtBQUFBLFVBQUEsSUFBRyxXQUFIO0FBQ0MsWUFBQSxRQUFBLENBQVMsR0FBVCxDQUFBLENBQUE7QUFDQSxrQkFBQSxDQUZEO1dBQUE7QUFBQSxVQU9BLEdBQUEsR0FBTSxPQVBOLENBQUE7aUJBU0EsS0FBQyxDQUFBLEtBQUssQ0FBQyxhQUFQLENBQXFCLFNBQUMsT0FBRCxHQUFBO0FBQ3BCLGdCQUFBLDRFQUFBO0FBQUEsWUFBQSxJQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsT0FBakIsQ0FBeUIsS0FBekIsQ0FBQSxLQUFtQyxDQUF0QztBQUNDLGNBQUEsSUFBRyxPQUFBLEdBQVUsT0FBYjtBQUNDLGdCQUFBLEdBQUEsR0FBTSxXQUFOLENBREQ7ZUFBQSxNQUFBO0FBR0MsZ0JBQUEsR0FBQSxHQUFNLFdBQU4sQ0FIRDtlQUREO2FBQUE7QUFBQSxZQU1BLElBQUEsR0FBTyxFQU5QLENBQUE7QUFBQSxZQVFBLElBQUksQ0FBQyxJQUFMLENBQVUsS0FBQyxDQUFBLEtBQUssQ0FBQyxJQUFQLENBQVksS0FBQyxDQUFBLEtBQUssQ0FBQyxNQUFQLENBQWMsV0FBZCxDQUFBLEdBQTZCLE9BQTdCLEdBQXVDLEdBQW5ELENBQVYsQ0FSQSxDQUFBO0FBVUE7QUFBQSxpQkFBQSwyQ0FBQTtpQ0FBQTtBQUNDLGNBQUEsSUFBSSxDQUFDLElBQUwsQ0FBVSxnQkFBQSxHQUFtQixLQUFDLENBQUEsS0FBSyxDQUFDLElBQVAsQ0FBWSxPQUFaLENBQTdCLENBQUEsQ0FERDtBQUFBLGFBVkE7QUFhQTtBQUFBLGlCQUFBLDhDQUFBO2tDQUFBO0FBQ0MsY0FBQSxJQUFJLENBQUMsSUFBTCxDQUFVLHlCQUFBLEdBQTRCLEtBQUMsQ0FBQSxLQUFLLENBQUMsSUFBUCxDQUFZLE9BQVosQ0FBdEMsQ0FBQSxDQUREO0FBQUEsYUFiQTtBQWdCQTtBQUFBLGlCQUFBLDhDQUFBO29DQUFBO0FBQ0MsY0FBQSxJQUFJLENBQUMsSUFBTCxDQUFVLGVBQUEsR0FBa0IsS0FBQyxDQUFBLEtBQUssQ0FBQyxJQUFQLENBQVksU0FBWixDQUE1QixDQUFBLENBQUE7QUFBQSxjQUNBLElBQUksQ0FBQyxJQUFMLENBQVUsbUJBQUEsR0FBc0IsS0FBQyxDQUFBLEtBQUssQ0FBQyxJQUFQLENBQVksU0FBWixDQUFoQyxDQURBLENBREQ7QUFBQSxhQWhCQTtBQUFBLFlBb0JBLElBQUksQ0FBQyxJQUFMLENBQVUsVUFBQSxHQUFhLEtBQUMsQ0FBQSxLQUFLLENBQUMsSUFBUCxDQUFZLEtBQUMsQ0FBQSxLQUFLLENBQUMsV0FBUCxDQUFtQixNQUFuQixDQUFaLENBQXZCLENBcEJBLENBQUE7bUJBeUJBLElBQUEsQ0FBSyxJQUFJLENBQUMsSUFBTCxDQUFVLEdBQVYsQ0FBTCxDQUFvQixDQUFDLEdBQXJCLENBQXlCLFNBQUEsR0FBQTtBQUN4QixjQUFBLElBQWtDLEdBQUcsQ0FBQyxVQUFKLENBQWUsY0FBZixDQUFsQztBQUFBLGdCQUFBLEdBQUcsQ0FBQyxVQUFKLENBQWUsY0FBZixDQUFBLENBQUE7ZUFBQTtBQUFBLGNBRUEsT0FBTyxDQUFDLEdBQVIsQ0FBWSxjQUFaLENBRkEsQ0FBQTtxQkFJQSxRQUFBLENBQUEsRUFMd0I7WUFBQSxDQUF6QixFQTFCb0I7VUFBQSxDQUFyQixFQVYrQjtRQUFBLEVBQUE7TUFBQSxDQUFBLENBQUEsQ0FBQSxJQUFBLENBQWhDLEVBekVZO0lBQUEsQ0F2QmIsQ0FBQTs7bUJBQUE7O01BUkQsQ0FBQTs7QUFBQSxFQW1KQSxNQUFNLENBQUMsT0FBUCxHQUFpQixPQW5KakIsQ0FBQTtBQUFBIiwiZmlsZSI6ImZsYXNzZXQuanMiLCJzb3VyY2VSb290IjoiL3NvdXJjZS8iLCJzb3VyY2VzQ29udGVudCI6WyIkZnMgPSByZXF1aXJlKCdmcy1leHRyYScpXG4kcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKVxuYXN5bmMgPSByZXF1aXJlKCdhc3luYycpXG5leGVjID0gcmVxdWlyZSgnZG9uZS1leGVjJylcbntTb3VyY2VDb2xsZWN0b3J9ID0gcmVxdWlyZSgnLi9mbHV0aWxzJylcblxuXG5jbGFzcyBGbGFzc2V0XG5cdGNvbnN0cnVjdG9yOiAoYnVpbGQpIC0+XG5cdFx0QGNvbGxlY3RvciA9IG5ldyBTb3VyY2VDb2xsZWN0b3IoYnVpbGQpXG5cdFx0QGJ1aWxkID0gYnVpbGRcblx0XHRAYXNzZXRzID0gW11cblxuXHRlbWJlZDogKGV4dG5hbWUsIGZpbGUsIGNsYXNzTmFtZSkgLT5cblx0XHRzd2l0Y2ggZXh0bmFtZS50b0xvd2VyQ2FzZSgpXG5cdFx0XHR3aGVuICcuanBnJywgJy5qcGVnJywgJy5naWYnLCAnLnBuZycsICcuc3ZnJywgJy5tcDMnLCAnLnN3ZicgdGhlbiBcIltFbWJlZChzb3VyY2U9JyN7ZmlsZX0nKV0gcHVibGljIHN0YXRpYyBjb25zdCAje2NsYXNzTmFtZX0gOiBDbGFzcztcIlxuXHRcdFx0ZWxzZSBcIltFbWJlZChzb3VyY2U9JyN7ZmlsZX0nLCBtaW1lVHlwZT0nYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtJyldIHB1YmxpYyBzdGF0aWMgY29uc3QgI3tjbGFzc05hbWV9IDogQ2xhc3M7XCJcblxuXHQjPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cdCMgc2V0dGluZ1xuXHQjPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cdGFkZEFzc2V0RGlyZWN0b3J5OiAoYXNzZXRDbGFzc1BhdGgsIGRpcmVjdG9yeSkgPT5cblx0XHRAYXNzZXRzLnB1c2hcblx0XHRcdGFzc2V0Q2xhc3NQYXRoOiBhc3NldENsYXNzUGF0aFxuXHRcdFx0ZGlyZWN0b3J5OiBkaXJlY3RvcnlcblxuXHQjPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cdCMgYnVpbGRcblx0IyAtIHN3YyBmaWxlXG5cdCMgLSBicm9jaHVyZSBmaWxlIHsgaW1hZ2UgcHJldmlldywgdmFyaWFibGUsIGltYWdlIHNpemUgfVxuXHQjPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cdGNyZWF0ZUFzc2V0OiAob3V0cHV0LCBjb21wbGV0ZSkgPT5cblx0XHRjYWNoZURpcmVjdG9yeSA9ICRwYXRoLm5vcm1hbGl6ZSgnLmFzc2V0c19jYWNoZScpXG5cdFx0Y2xhc3NOYW1lUmVnID0gL15bQS1aYS16XVtBLVphLXowLTlfXSsvO1xuXHRcdGVtYmVkID0gQGVtYmVkXG5cblx0XHRAY29sbGVjdG9yLmFkZFNvdXJjZURpcmVjdG9yeSgkcGF0aC5qb2luKGNhY2hlRGlyZWN0b3J5LCAnc3JjJykpXG5cblx0XHQjIHJlbW92ZSBjYWNoZSBkaXJlY3RvcnkgaWYgZXhpc3RzXG5cdFx0JGZzLnJlbW92ZVN5bmMoY2FjaGVEaXJlY3RvcnkpIGlmICRmcy5leGlzdHNTeW5jKGNhY2hlRGlyZWN0b3J5KVxuXG5cdFx0dGFzayA9IChvYmosIG5leHQpIC0+XG5cdFx0XHRhc3NldENsYXNzUGF0aCA9IG9ialsnYXNzZXRDbGFzc1BhdGgnXVxuXHRcdFx0ZGlyZWN0b3J5ID0gb2JqWydkaXJlY3RvcnknXVxuXG5cdFx0XHRwYXRocyA9IGFzc2V0Q2xhc3NQYXRoLnNwbGl0KCcuJylcblx0XHRcdGNsYXNzTmFtZSA9IHBhdGhzLnBvcCgpXG5cdFx0XHRuYW1lc3BhY2UgPSBwYXRocy5qb2luKCcuJylcblx0XHRcdHBhdGhzLnVuc2hpZnQoY2FjaGVEaXJlY3RvcnksICdzcmMnKVxuXG5cdFx0XHRzb3VyY2VEaXJlY3RvcnkgPSBwYXRocy5qb2luKCcvJylcblxuXHRcdFx0Iy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cblx0XHRcdCMgMSBta2RpciBzcmNcblx0XHRcdCMtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cdFx0XHQkZnMubWtkaXJzIHNvdXJjZURpcmVjdG9yeSwgKGVycikgLT5cblx0XHRcdFx0aWYgZXJyP1xuXHRcdFx0XHRcdG5leHQoZXJyKVxuXHRcdFx0XHRcdHJldHVyblxuXG5cdFx0XHRcdCMtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cdFx0XHRcdCMgMiBjbG9uZSBmaWxlc1xuXHRcdFx0XHQjLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXHRcdFx0XHQkZnMuY29weSBkaXJlY3RvcnksIHNvdXJjZURpcmVjdG9yeSwgKGVycikgLT5cblx0XHRcdFx0XHRpZiBlcnI/XG5cdFx0XHRcdFx0XHRuZXh0KGVycilcblx0XHRcdFx0XHRcdHJldHVyblxuXG5cdFx0XHRcdFx0Iy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cblx0XHRcdFx0XHQjIDMgY3JlYXRlIHNvdXJjZSBjb2RlXG5cdFx0XHRcdFx0Iy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cblx0XHRcdFx0XHRmaWxlcyA9ICRmcy5yZWFkZGlyU3luYyhzb3VyY2VEaXJlY3RvcnkpXG5cdFx0XHRcdFx0ZW1iZWRzID0gW11cblxuXHRcdFx0XHRcdGZvciBmaWxlIGluIGZpbGVzXG5cdFx0XHRcdFx0XHRzdGF0ID0gJGZzLnN0YXRTeW5jKCRwYXRoLmpvaW4oc291cmNlRGlyZWN0b3J5LCBmaWxlKSlcblx0XHRcdFx0XHRcdGV4dG5hbWUgPSAkcGF0aC5leHRuYW1lKGZpbGUpXG5cdFx0XHRcdFx0XHRmaWxlQ2xhc3NOYW1lID0gZmlsZS5yZXBsYWNlKGV4dG5hbWUsICcnKVxuXG5cdFx0XHRcdFx0XHRpZiBzdGF0LmlzRmlsZSgpIGFuZCBjbGFzc05hbWVSZWcudGVzdChmaWxlQ2xhc3NOYW1lKVxuXHRcdFx0XHRcdFx0XHRlbWJlZHMucHVzaChlbWJlZChleHRuYW1lLCBmaWxlLCBmaWxlQ2xhc3NOYW1lKSlcblxuXG5cdFx0XHRcdFx0c291cmNlID0gXCJcIlwiXG5cdFx0XHRcdFx0XHRcdHBhY2thZ2UgI3tuYW1lc3BhY2V9IHtcblx0XHRcdFx0XHRcdFx0cHVibGljIGNsYXNzICN7Y2xhc3NOYW1lfSB7XG5cdFx0XHRcdFx0XHRcdCN7ZW1iZWRzLmpvaW4oJ1xcbicpfVxuXHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdFx0XCJcIlwiXG5cblx0XHRcdFx0XHQjLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXHRcdFx0XHRcdCMgNCBjcmVhdGUgc291cmNlIGZpbGVcblx0XHRcdFx0XHQjLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXHRcdFx0XHRcdCRmcy53cml0ZUZpbGUgJHBhdGguam9pbihzb3VyY2VEaXJlY3RvcnksIFwiI3tjbGFzc05hbWV9LmFzXCIpLCBzb3VyY2UsIHtlbmNvZGluZzondXRmOCd9LCAoZXJyKSAtPlxuXHRcdFx0XHRcdFx0aWYgZXJyP1xuXHRcdFx0XHRcdFx0XHRuZXh0KGVycilcblx0XHRcdFx0XHRcdFx0cmV0dXJuXG5cblx0XHRcdFx0XHRcdG5leHQoKVxuXG5cdFx0Iy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cblx0XHQjIDAgZWFjaCBhc3NldHNcblx0XHQjLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXHRcdGFzeW5jLmVhY2hTZXJpZXMgQGFzc2V0cywgdGFzaywgKGVycikgPT5cblx0XHRcdGlmIGVycj9cblx0XHRcdFx0Y29tcGxldGUoZXJyKVxuXHRcdFx0XHRyZXR1cm5cblxuXHRcdFx0Iy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cblx0XHRcdCMgNSBjcmVhdGUgYnVpbGQgY29tbWFuZFxuXHRcdFx0Iy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cblx0XHRcdGJpbiA9ICdjb21wYydcblxuXHRcdFx0QGJ1aWxkLmdldFNES1ZlcnNpb24gKHZlcnNpb24pID0+XG5cdFx0XHRcdGlmIHByb2Nlc3MucGxhdGZvcm0uaW5kZXhPZignd2luJykgaXMgMFxuXHRcdFx0XHRcdGlmIHZlcnNpb24gPiAnNC42LjAnXG5cdFx0XHRcdFx0XHRiaW4gPSAnY29tcGMuYmF0J1xuXHRcdFx0XHRcdGVsc2Vcblx0XHRcdFx0XHRcdGJpbiA9ICdjb21wYy5leGUnXG5cblx0XHRcdFx0YXJncyA9IFtdXG5cblx0XHRcdFx0YXJncy5wdXNoKEBidWlsZC53cmFwKEBidWlsZC5nZXRFbnYoJ0ZMRVhfSE9NRScpICsgJy9iaW4vJyArIGJpbikpXG5cblx0XHRcdFx0Zm9yIGxpYnJhcnkgaW4gQGNvbGxlY3Rvci5nZXRMaWJyYXJpZXMoKVxuXHRcdFx0XHRcdGFyZ3MucHVzaCgnLWxpYnJhcnktcGF0aCAnICsgQGJ1aWxkLndyYXAobGlicmFyeSkpXG5cblx0XHRcdFx0Zm9yIGxpYnJhcnkgaW4gQGNvbGxlY3Rvci5nZXRFeHRlcm5hbExpYnJhcmllcygpXG5cdFx0XHRcdFx0YXJncy5wdXNoKCctZXh0ZXJuYWwtbGlicmFyeS1wYXRoICcgKyBAYnVpbGQud3JhcChsaWJyYXJ5KSlcblxuXHRcdFx0XHRmb3IgZGlyZWN0b3J5IGluIEBjb2xsZWN0b3IuZ2V0U291cmNlRGlyZWN0b3JpZXMoKVxuXHRcdFx0XHRcdGFyZ3MucHVzaCgnLXNvdXJjZS1wYXRoICcgKyBAYnVpbGQud3JhcChkaXJlY3RvcnkpKVxuXHRcdFx0XHRcdGFyZ3MucHVzaCgnLWluY2x1ZGUtc291cmNlcyAnICsgQGJ1aWxkLndyYXAoZGlyZWN0b3J5KSlcblxuXHRcdFx0XHRhcmdzLnB1c2goJy1vdXRwdXQgJyArIEBidWlsZC53cmFwKEBidWlsZC5yZXNvbHZlUGF0aChvdXRwdXQpKSlcblxuXHRcdFx0XHQjLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXHRcdFx0XHQjIDYgZXhlYyBjb21wY1xuXHRcdFx0XHQjLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXHRcdFx0XHRleGVjKGFyZ3Muam9pbignICcpKS5ydW4gKCkgLT5cblx0XHRcdFx0XHQkZnMucmVtb3ZlU3luYyhjYWNoZURpcmVjdG9yeSkgaWYgJGZzLmV4aXN0c1N5bmMoY2FjaGVEaXJlY3RvcnkpXG5cblx0XHRcdFx0XHRjb25zb2xlLmxvZyhjYWNoZURpcmVjdG9yeSlcblxuXHRcdFx0XHRcdGNvbXBsZXRlKClcblxubW9kdWxlLmV4cG9ydHMgPSBGbGFzc2V0Il19