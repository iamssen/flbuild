(function() {
  var $fs, $path, Flasset, SourceCollector, async, exec,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  $fs = require('fs-extra');

  $path = require('path');

  async = require('async');

  exec = require('done-exec');

  SourceCollector = require('./flutils').SourceCollector;

  Flasset = (function() {
    function Flasset(build) {
      this.create = __bind(this.create, this);
      this.addAssetDirectory = __bind(this.addAssetDirectory, this);
      this.collector = new SourceCollector(build);
      this.build = build;
      this.assets = [];
    }

    Flasset.prototype.embed = function(extname, file, className) {
      switch (extname.toLowerCase()) {
        case '.jpg':
        case '.jpeg':
        case '.gif':
        case '.png':
        case '.svg':
        case '.mp3':
        case '.swf':
          return "[Embed(source='" + file + "')] public static const " + className + " : Class;";
        default:
          return "[Embed(source='" + file + "', mimeType='application/octet-stream')] public static const " + className + " : Class;";
      }
    };

    Flasset.prototype.addAssetDirectory = function(assetClassPath, directory) {
      return this.assets.push({
        assetClassPath: assetClassPath,
        directory: directory
      });
    };

    Flasset.prototype.create = function(output, complete) {
      var cacheDirectory, classNameReg, embed, task;
      cacheDirectory = $path.normalize('.assets_cache');
      classNameReg = /^[A-Za-z][A-Za-z0-9_]+/;
      embed = this.embed;
      this.collector.addSourceDirectory($path.join(cacheDirectory, 'src'));
      if ($fs.existsSync(cacheDirectory)) {
        $fs.removeSync(cacheDirectory);
      }
      task = function(obj, next) {
        var assetClassPath, className, directory, namespace, paths, sourceDirectory;
        assetClassPath = obj['assetClassPath'];
        directory = obj['directory'];
        paths = assetClassPath.split('.');
        className = paths.pop();
        namespace = paths.join('.');
        paths.unshift(cacheDirectory, 'src');
        sourceDirectory = paths.join('/');
        return $fs.mkdirs(sourceDirectory, function(err) {
          if (err != null) {
            next(err);
            return;
          }
          return $fs.copy(directory, sourceDirectory, function(err) {
            var embeds, extname, file, fileClassName, files, source, stat, _i, _len;
            if (err != null) {
              next(err);
              return;
            }
            files = $fs.readdirSync(sourceDirectory);
            embeds = [];
            for (_i = 0, _len = files.length; _i < _len; _i++) {
              file = files[_i];
              stat = $fs.statSync($path.join(sourceDirectory, file));
              extname = $path.extname(file);
              fileClassName = file.replace(extname, '');
              if (stat.isFile() && classNameReg.test(fileClassName)) {
                embeds.push(embed(extname, file, fileClassName));
              }
            }
            source = "package " + namespace + " {\npublic class " + className + " {\n" + (embeds.join('\n')) + "\n}\n}";
            return $fs.writeFile($path.join(sourceDirectory, "" + className + ".as"), source, {
              encoding: 'utf8'
            }, function(err) {
              if (err != null) {
                next(err);
                return;
              }
              return next();
            });
          });
        });
      };
      return async.eachSeries(this.assets, task, (function(_this) {
        return function(err) {
          var bin;
          if (err != null) {
            complete(err);
            return;
          }
          bin = 'compc';
          return _this.build.getSDKVersion(function(version) {
            var args, directory, library, _i, _j, _k, _len, _len1, _len2, _ref, _ref1, _ref2;
            if (_this.build.isWindow()) {
              if (version > '4.6.0') {
                bin = 'compc.bat';
              } else {
                bin = 'compc.exe';
              }
            }
            args = [];
            args.push(_this.build.wrap($path.join(_this.build.getEnv('FLEX_HOME'), 'bin', bin)));
            _ref = _this.collector.getLibraries();
            for (_i = 0, _len = _ref.length; _i < _len; _i++) {
              library = _ref[_i];
              args.push('-library-path ' + _this.build.wrap(library));
            }
            _ref1 = _this.collector.getExternalLibraries();
            for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
              library = _ref1[_j];
              args.push('-external-library-path ' + _this.build.wrap(library));
            }
            _ref2 = _this.collector.getSourceDirectories();
            for (_k = 0, _len2 = _ref2.length; _k < _len2; _k++) {
              directory = _ref2[_k];
              args.push('-source-path ' + _this.build.wrap(directory));
              args.push('-include-sources ' + _this.build.wrap(directory));
            }
            args.push('-output ' + _this.build.wrap(_this.build.resolvePath(output)));
            return exec(args.join(' ')).run(function() {
              if ($fs.existsSync(cacheDirectory)) {
                $fs.removeSync(cacheDirectory);
              }
              console.log(cacheDirectory);
              return complete();
            });
          });
        };
      })(this));
    };

    return Flasset;

  })();

  module.exports = Flasset;

}).call(this);

//# sourceMappingURL=data:application/json;base64,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QUEsSUFBa0MsR0FBRyxDQUFDLFVBQUosQ0FBZSxjQUFmLENBQWxDO0FBQUEsZ0JBQUEsR0FBRyxDQUFDLFVBQUosQ0FBZSxjQUFmLENBQUEsQ0FBQTtlQUFBO0FBQUEsY0FFQSxPQUFPLENBQUMsR0FBUixDQUFZLGNBQVosQ0FGQSxDQUFBO3FCQUlBLFFBQUEsQ0FBQSxFQUx3QjtZQUFBLENBQXpCLEVBMUJvQjtVQUFBLENBQXJCLEVBVitCO1FBQUEsRUFBQTtNQUFBLENBQUEsQ0FBQSxDQUFBLElBQUEsQ0FBaEMsRUF6RU87SUFBQSxDQXZCUixDQUFBOzttQkFBQTs7TUFSRCxDQUFBOztBQUFBLEVBbUpBLE1BQU0sQ0FBQyxPQUFQLEdBQWlCLE9BbkpqQixDQUFBO0FBQUEiLCJmaWxlIjoiZmxhc3NldC5qcyIsInNvdXJjZVJvb3QiOiIvc291cmNlLyIsInNvdXJjZXNDb250ZW50IjpbIiRmcyA9IHJlcXVpcmUoJ2ZzLWV4dHJhJylcbiRwYXRoID0gcmVxdWlyZSgncGF0aCcpXG5hc3luYyA9IHJlcXVpcmUoJ2FzeW5jJylcbmV4ZWMgPSByZXF1aXJlKCdkb25lLWV4ZWMnKVxue1NvdXJjZUNvbGxlY3Rvcn0gPSByZXF1aXJlKCcuL2ZsdXRpbHMnKVxuXG5cbmNsYXNzIEZsYXNzZXRcblx0Y29uc3RydWN0b3I6IChidWlsZCkgLT5cblx0XHRAY29sbGVjdG9yID0gbmV3IFNvdXJjZUNvbGxlY3RvcihidWlsZClcblx0XHRAYnVpbGQgPSBidWlsZFxuXHRcdEBhc3NldHMgPSBbXVxuXG5cdGVtYmVkOiAoZXh0bmFtZSwgZmlsZSwgY2xhc3NOYW1lKSAtPlxuXHRcdHN3aXRjaCBleHRuYW1lLnRvTG93ZXJDYXNlKClcblx0XHRcdHdoZW4gJy5qcGcnLCAnLmpwZWcnLCAnLmdpZicsICcucG5nJywgJy5zdmcnLCAnLm1wMycsICcuc3dmJyB0aGVuIFwiW0VtYmVkKHNvdXJjZT0nI3tmaWxlfScpXSBwdWJsaWMgc3RhdGljIGNvbnN0ICN7Y2xhc3NOYW1lfSA6IENsYXNzO1wiXG5cdFx0XHRlbHNlIFwiW0VtYmVkKHNvdXJjZT0nI3tmaWxlfScsIG1pbWVUeXBlPSdhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW0nKV0gcHVibGljIHN0YXRpYyBjb25zdCAje2NsYXNzTmFtZX0gOiBDbGFzcztcIlxuXG5cdCM9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblx0IyBzZXR0aW5nXG5cdCM9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblx0YWRkQXNzZXREaXJlY3Rvcnk6IChhc3NldENsYXNzUGF0aCwgZGlyZWN0b3J5KSA9PlxuXHRcdEBhc3NldHMucHVzaFxuXHRcdFx0YXNzZXRDbGFzc1BhdGg6IGFzc2V0Q2xhc3NQYXRoXG5cdFx0XHRkaXJlY3Rvcnk6IGRpcmVjdG9yeVxuXG5cdCM9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblx0IyBjcmVhdGVcblx0IyAtIHN3YyBmaWxlXG5cdCMgLSBicm9jaHVyZSBmaWxlIHsgaW1hZ2UgcHJldmlldywgdmFyaWFibGUsIGltYWdlIHNpemUgfVxuXHQjPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cdGNyZWF0ZTogKG91dHB1dCwgY29tcGxldGUpID0+XG5cdFx0Y2FjaGVEaXJlY3RvcnkgPSAkcGF0aC5ub3JtYWxpemUoJy5hc3NldHNfY2FjaGUnKVxuXHRcdGNsYXNzTmFtZVJlZyA9IC9eW0EtWmEtel1bQS1aYS16MC05X10rLztcblx0XHRlbWJlZCA9IEBlbWJlZFxuXG5cdFx0QGNvbGxlY3Rvci5hZGRTb3VyY2VEaXJlY3RvcnkoJHBhdGguam9pbihjYWNoZURpcmVjdG9yeSwgJ3NyYycpKVxuXG5cdFx0IyByZW1vdmUgY2FjaGUgZGlyZWN0b3J5IGlmIGV4aXN0c1xuXHRcdCRmcy5yZW1vdmVTeW5jKGNhY2hlRGlyZWN0b3J5KSBpZiAkZnMuZXhpc3RzU3luYyhjYWNoZURpcmVjdG9yeSlcblxuXHRcdHRhc2sgPSAob2JqLCBuZXh0KSAtPlxuXHRcdFx0YXNzZXRDbGFzc1BhdGggPSBvYmpbJ2Fzc2V0Q2xhc3NQYXRoJ11cblx0XHRcdGRpcmVjdG9yeSA9IG9ialsnZGlyZWN0b3J5J11cblxuXHRcdFx0cGF0aHMgPSBhc3NldENsYXNzUGF0aC5zcGxpdCgnLicpXG5cdFx0XHRjbGFzc05hbWUgPSBwYXRocy5wb3AoKVxuXHRcdFx0bmFtZXNwYWNlID0gcGF0aHMuam9pbignLicpXG5cdFx0XHRwYXRocy51bnNoaWZ0KGNhY2hlRGlyZWN0b3J5LCAnc3JjJylcblxuXHRcdFx0c291cmNlRGlyZWN0b3J5ID0gcGF0aHMuam9pbignLycpXG5cblx0XHRcdCMtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cdFx0XHQjIDEgbWtkaXIgc3JjXG5cdFx0XHQjLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXHRcdFx0JGZzLm1rZGlycyBzb3VyY2VEaXJlY3RvcnksIChlcnIpIC0+XG5cdFx0XHRcdGlmIGVycj9cblx0XHRcdFx0XHRuZXh0KGVycilcblx0XHRcdFx0XHRyZXR1cm5cblxuXHRcdFx0XHQjLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXHRcdFx0XHQjIDIgY2xvbmUgZmlsZXNcblx0XHRcdFx0Iy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cblx0XHRcdFx0JGZzLmNvcHkgZGlyZWN0b3J5LCBzb3VyY2VEaXJlY3RvcnksIChlcnIpIC0+XG5cdFx0XHRcdFx0aWYgZXJyP1xuXHRcdFx0XHRcdFx0bmV4dChlcnIpXG5cdFx0XHRcdFx0XHRyZXR1cm5cblxuXHRcdFx0XHRcdCMtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cdFx0XHRcdFx0IyAzIGNyZWF0ZSBzb3VyY2UgY29kZVxuXHRcdFx0XHRcdCMtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cdFx0XHRcdFx0ZmlsZXMgPSAkZnMucmVhZGRpclN5bmMoc291cmNlRGlyZWN0b3J5KVxuXHRcdFx0XHRcdGVtYmVkcyA9IFtdXG5cblx0XHRcdFx0XHRmb3IgZmlsZSBpbiBmaWxlc1xuXHRcdFx0XHRcdFx0c3RhdCA9ICRmcy5zdGF0U3luYygkcGF0aC5qb2luKHNvdXJjZURpcmVjdG9yeSwgZmlsZSkpXG5cdFx0XHRcdFx0XHRleHRuYW1lID0gJHBhdGguZXh0bmFtZShmaWxlKVxuXHRcdFx0XHRcdFx0ZmlsZUNsYXNzTmFtZSA9IGZpbGUucmVwbGFjZShleHRuYW1lLCAnJylcblxuXHRcdFx0XHRcdFx0aWYgc3RhdC5pc0ZpbGUoKSBhbmQgY2xhc3NOYW1lUmVnLnRlc3QoZmlsZUNsYXNzTmFtZSlcblx0XHRcdFx0XHRcdFx0ZW1iZWRzLnB1c2goZW1iZWQoZXh0bmFtZSwgZmlsZSwgZmlsZUNsYXNzTmFtZSkpXG5cblxuXHRcdFx0XHRcdHNvdXJjZSA9IFwiXCJcIlxuXHRcdFx0XHRcdFx0XHRwYWNrYWdlICN7bmFtZXNwYWNlfSB7XG5cdFx0XHRcdFx0XHRcdHB1YmxpYyBjbGFzcyAje2NsYXNzTmFtZX0ge1xuXHRcdFx0XHRcdFx0XHQje2VtYmVkcy5qb2luKCdcXG4nKX1cblx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHRcdFwiXCJcIlxuXG5cdFx0XHRcdFx0Iy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cblx0XHRcdFx0XHQjIDQgY3JlYXRlIHNvdXJjZSBmaWxlXG5cdFx0XHRcdFx0Iy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cblx0XHRcdFx0XHQkZnMud3JpdGVGaWxlICRwYXRoLmpvaW4oc291cmNlRGlyZWN0b3J5LCBcIiN7Y2xhc3NOYW1lfS5hc1wiKSwgc291cmNlLCB7ZW5jb2Rpbmc6J3V0ZjgnfSwgKGVycikgLT5cblx0XHRcdFx0XHRcdGlmIGVycj9cblx0XHRcdFx0XHRcdFx0bmV4dChlcnIpXG5cdFx0XHRcdFx0XHRcdHJldHVyblxuXG5cdFx0XHRcdFx0XHRuZXh0KClcblxuXHRcdCMtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cdFx0IyAwIGVhY2ggYXNzZXRzXG5cdFx0Iy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cblx0XHRhc3luYy5lYWNoU2VyaWVzIEBhc3NldHMsIHRhc2ssIChlcnIpID0+XG5cdFx0XHRpZiBlcnI/XG5cdFx0XHRcdGNvbXBsZXRlKGVycilcblx0XHRcdFx0cmV0dXJuXG5cblx0XHRcdCMtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cdFx0XHQjIDUgY3JlYXRlIGJ1aWxkIGNvbW1hbmRcblx0XHRcdCMtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cdFx0XHRiaW4gPSAnY29tcGMnXG5cblx0XHRcdEBidWlsZC5nZXRTREtWZXJzaW9uICh2ZXJzaW9uKSA9PlxuXHRcdFx0XHRpZiBAYnVpbGQuaXNXaW5kb3coKVxuXHRcdFx0XHRcdGlmIHZlcnNpb24gPiAnNC42LjAnXG5cdFx0XHRcdFx0XHRiaW4gPSAnY29tcGMuYmF0J1xuXHRcdFx0XHRcdGVsc2Vcblx0XHRcdFx0XHRcdGJpbiA9ICdjb21wYy5leGUnXG5cblx0XHRcdFx0YXJncyA9IFtdXG5cblx0XHRcdFx0YXJncy5wdXNoKEBidWlsZC53cmFwKCRwYXRoLmpvaW4oQGJ1aWxkLmdldEVudignRkxFWF9IT01FJyksICdiaW4nLCBiaW4pKSlcblxuXHRcdFx0XHRmb3IgbGlicmFyeSBpbiBAY29sbGVjdG9yLmdldExpYnJhcmllcygpXG5cdFx0XHRcdFx0YXJncy5wdXNoKCctbGlicmFyeS1wYXRoICcgKyBAYnVpbGQud3JhcChsaWJyYXJ5KSlcblxuXHRcdFx0XHRmb3IgbGlicmFyeSBpbiBAY29sbGVjdG9yLmdldEV4dGVybmFsTGlicmFyaWVzKClcblx0XHRcdFx0XHRhcmdzLnB1c2goJy1leHRlcm5hbC1saWJyYXJ5LXBhdGggJyArIEBidWlsZC53cmFwKGxpYnJhcnkpKVxuXG5cdFx0XHRcdGZvciBkaXJlY3RvcnkgaW4gQGNvbGxlY3Rvci5nZXRTb3VyY2VEaXJlY3RvcmllcygpXG5cdFx0XHRcdFx0YXJncy5wdXNoKCctc291cmNlLXBhdGggJyArIEBidWlsZC53cmFwKGRpcmVjdG9yeSkpXG5cdFx0XHRcdFx0YXJncy5wdXNoKCctaW5jbHVkZS1zb3VyY2VzICcgKyBAYnVpbGQud3JhcChkaXJlY3RvcnkpKVxuXG5cdFx0XHRcdGFyZ3MucHVzaCgnLW91dHB1dCAnICsgQGJ1aWxkLndyYXAoQGJ1aWxkLnJlc29sdmVQYXRoKG91dHB1dCkpKVxuXG5cdFx0XHRcdCMtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cdFx0XHRcdCMgNiBleGVjIGNvbXBjXG5cdFx0XHRcdCMtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cdFx0XHRcdGV4ZWMoYXJncy5qb2luKCcgJykpLnJ1biAoKSAtPlxuXHRcdFx0XHRcdCRmcy5yZW1vdmVTeW5jKGNhY2hlRGlyZWN0b3J5KSBpZiAkZnMuZXhpc3RzU3luYyhjYWNoZURpcmVjdG9yeSlcblxuXHRcdFx0XHRcdGNvbnNvbGUubG9nKGNhY2hlRGlyZWN0b3J5KVxuXG5cdFx0XHRcdFx0Y29tcGxldGUoKVxuXG5tb2R1bGUuZXhwb3J0cyA9IEZsYXNzZXQiXX0=